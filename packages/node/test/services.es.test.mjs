import t from"chai";import e from"sinon";import r from"sinon-chai";import o from"pg-promise";import n from"pg-monitor";import"exponential-backoff";import s from"dotenv";import i from"is-primitive";import a from"is-plain-object";import l from"fs";import c from"os";import{dirname as f}from"path";import{fileURLToPath as u}from"url";import{createLogger as p,format as m,transports as y}from"winston";const{deleteProperty:h}=Reflect;const d=i;const g=a;const v=t=>"object"==typeof t&&null!==t||"function"==typeof t;const _=t=>{if(!d(t))throw new TypeError("Object keys must be strings or symbols");if((t=>"__proto__"===t||"constructor"===t||"prototype"===t)(t))throw new Error(`Cannot set unsafe key: "${t}"`)};const b=(t,e)=>e&&"function"==typeof e.split?e.split(t):"symbol"==typeof t?[t]:Array.isArray(t)?t:((t,e,r)=>{const o=(t=>Array.isArray(t)?t.flat().map(String).join(","):t)(e?((t,e)=>{if("string"!=typeof t||!e)return t;let r=t+";";return void 0!==e.arrays&&(r+=`arrays=${e.arrays};`),void 0!==e.separator&&(r+=`separator=${e.separator};`),void 0!==e.split&&(r+=`split=${e.split};`),void 0!==e.merge&&(r+=`merge=${e.merge};`),void 0!==e.preservePaths&&(r+=`preservePaths=${e.preservePaths};`),r})(t,e):t);_(o);const n=E.cache.get(o)||r();return E.cache.set(o,n),n})(t,e,(()=>((t,e={})=>{const r=e.separator||".";const o="/"!==r&&e.preservePaths;if("string"==typeof t&&!1!==o&&/\//.test(t))return[t];const n=[];let s="";const i=t=>{let e;""!==t.trim()&&Number.isInteger(e=Number(t))?n.push(e):n.push(t)};for(let e=0;e<t.length;e++){const o=t[e];"\\"!==o?o!==r?s+=o:(i(s),s=""):s+=t[++e]}return s&&i(s),n})(t,e)));const S=(t,e,r,o)=>{if(_(e),void 0===r)h(t,e);else if(o&&o.merge){const n="function"===o.merge?o.merge:Object.assign;n&&g(t[e])&&g(r)?t[e]=n(t[e],r):t[e]=r}else t[e]=r;return t};const E=(t,e,r,o)=>{if(!e||!v(t))return t;const n=b(e,o);let s=t;for(let t=0;t<n.length;t++){const e=n[t];const i=n[t+1];if(_(e),void 0===i){S(s,e,r,o);break}"number"!=typeof i||Array.isArray(s[e])?(v(s[e])||(s[e]={}),s=s[e]):s=s[e]=[]}return t};E.split=b,E.cache=new Map,E.clear=()=>{E.cache=new Map};var R=E;var w=l;var O="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};var T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};var A=function(){function t(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,r,o){return r&&t(e.prototype,r),o&&t(e,o),e}}();var P=function t(e,r){var o=r.indexOf(".");if(!~o){if(null==e)return;return e[r]}var n=r.substring(0,o),s=r.substring(o+1);if(null!=e)return e=e[n],s?t(e,s):e},N=R,C=function(t,e){if("function"!=typeof e)return JSON.parse(w.readFileSync(t));w.readFile(t,"utf-8",(function(t,r){try{r=JSON.parse(r)}catch(e){t=t||e}e(t,r)}))},M=l,$=c;var H=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.options=r=r||{},r.stringify_width=r.stringify_width||2,r.stringify_fn=r.stringify_fn||null,r.stringify_eol=r.stringify_eol||!1,r.ignore_dots=r.ignore_dots||!1,this.path=e,this.data=this.read()}return A(t,[{key:"set",value:function(t,e,r){var o=this;return"object"===(void 0===t?"undefined":T(t))?function(t,e){var r=0,o=[];if(Array.isArray(t))for(;r<t.length&&!1!==e(t[r],r);++r);else if("object"===(void 0===t?"undefined":O(t))&&null!==t)for(o=Object.keys(t);r<o.length&&!1!==e(t[o[r]],o[r]);++r);}(t,(function(t,e){N(o.data,e,t,r)})):this.options.ignore_dots?this.data[t]=e:N(this.data,t,e,r),this.options.autosave&&this.save(),this}},{key:"get",value:function(t){return t?this.options.ignore_dots?this.data[t]:P(this.data,t):this.toObject()}},{key:"unset",value:function(t){return this.set(t,void 0)}},{key:"append",value:function(t,e){var r=this.get(t);if(r=void 0===r?[]:r,!Array.isArray(r))throw new Error("The data is not an array!");return r.push(e),this.set(t,r),this}},{key:"pop",value:function(t){var e=this.get(t);if(!Array.isArray(e))throw new Error("The data is not an array!");return e.pop(),this.set(t,e),this}},{key:"read",value:function(t){if(!t)try{return C(this.path)}catch(t){return{}}C(this.path,(function(e,r){t(null,r=e?{}:r)}))}},{key:"write",value:function(t,e){return e?M.writeFile(this.path,t,e):M.writeFileSync(this.path,t),this}},{key:"empty",value:function(t){return this.write("{}",t)}},{key:"save",value:function(t){var e=JSON.stringify(this.data,this.options.stringify_fn,this.options.stringify_width,this.options.stringify_eol);return this.write(this.options.stringify_eol?e+$.EOL:e,t),this}},{key:"toObject",value:function(){return this.data}}]),t}();s.config();const I=new H(`${f(u(import.meta.url))}/../../package.json`,{stringify_eol:!0});const{PORT:x,ZMQ_URL:k,CHAIN:F,NETWORK:B,BCN_ENV:U,BCN_URL:j,DEBUG_MODE:D,POSTGRES_USER:G,POSTGRES_PASSWORD:L,POSTGRES_DB:W,POSTGRES_HOST:Y,POSTGRES_PORT:K,RPC_PROTOCOL:X,RPC_USER:J,RPC_PASSWORD:V,RPC_HOST:z,RPC_PORT:Q,SERVER_VERSION:Z,DEFAULT_WALLET:q,SYNC_INTERVAL_CHECK:tt,POSTGRES_MAX_PARAM_NUM:et,DB_CONNECTION_RETRY_TIME:rt,SIGNATURE_FRESHNESS_MINUTES:ot,ALLOWED_RPC_METHODS:nt,NODE_MAX_PROGRESS:st,SYNC_MAX_PROGRESS:at,MAX_BLOCKCHAIN_HEIGHT:lt,MWEB_HEIGHT:ct,BC_START_HEIGHT:ft,WORKER_ID:ut,NUM_WORKERS:pt,SYNC_NON_STANDARD:mt,ZMQ_WAIT_PERCENTAGE:yt}=process.env;const ht=U||"dev";const dt=parseInt(D,10)||1;const gt=G||"bcn";const vt=L||"bcn";const _t=W||"bcn";const bt=Y||"127.0.0.1";const St=parseInt(K,10)||"5432";Z||I.get("version"),!nt||nt.split(",").map((t=>new RegExp(t)));const Et=p({level:["error","warn","info","http","verbose","debug","silly"][dt],format:m.json(),transports:[new y.Console({format:m.combine(m.colorize(),m.timestamp({format:"MM-DD-YYYY HH:mm:ss"}),m.printf((t=>`[2m${t.timestamp}[0m ${t.level} ${t.message}`)))})],exceptionHandlers:[new y.File({filename:"logs/exceptions.log"})],rejectionHandlers:[new y.File({filename:"logs/rejections.log"})]});const Rt={maxFiles:1,maxSize:1e5};dt>=0&&Et.add(new y.File({filename:"error.log",level:"error"})),dt>=1&&Et.add(new y.File({filename:"logs/warn.log",level:"warn",...Rt})),dt>=2&&Et.add(new y.File({filename:"logs/info.log",level:"info",...Rt})),dt>=3&&Et.add(new y.File({filename:"logs/http.log",level:"http",...Rt})),dt>=4&&Et.add(new y.File({filename:"logs/verbose.log",level:"verbose",...Rt})),dt>=5&&Et.add(new y.File({filename:"logs/debug.log",level:"debug",...Rt}));const wt={error:(t,e)=>{if(e.cn){const{host:r,port:o,database:n,user:s,password:i}=e.cn;Et.debug(`Waiting for db to start { message:${t.message} host:${r}, port:${o}, database:${n}, user:${s}, password: ${i}`)}},noWarnings:!0};"dev"===ht&&dt>0&&(n.isAttached()?n.detach():(n.attach(wt),n.setTheme("matrix")));const Ot=o(wt)({host:bt,port:St,database:_t,user:gt,password:vt,allowExitOnIdle:!0,idleTimeoutMillis:100});const{PreparedStatement:Tt}=o;class At{static async getBalance(t){const e=new Tt({name:`Utxos.getBalance.${Math.random()}`,text:'SELECT sum("satoshis") as "satoshis" FROM "Utxos" WHERE "address" = $1',values:[t]});const r=await Ot.oneOrNone(e);return parseInt(r?.satoshis,10)||0}static async select(t){const e=new Tt({name:`Utxos.select.${Math.random()}`,text:'SELECT "address", "satoshis", "scriptPubKey", "rev" FROM "Utxos" WHERE "address" = $1',values:[t]});return(await Ot.any(e)).map((t=>({...t,satoshis:parseInt(t.satoshis,10)||0})))}}class Pt{static async getBalance(t){return At.getBalance(t)}static async select(t){return At.select(t)}}t.use(r);const{expect:Nt}=t;describe("services",(()=>{describe("Utxo.service",(()=>{it("Should return the balance of an address",(async()=>{const t="1C9UbB9P8Jba21mLiEXio14eRg8cBn9wyx";const r=e.stub(Pt,"getBalance").resolves(100);const o=await Pt.getBalance(t);Nt(r.calledWith(t)).to.be.true,Nt(o).eq(100),r.restore()}))}))}));
