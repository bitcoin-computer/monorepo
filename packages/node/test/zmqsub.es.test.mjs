import e from"bitcoind-rpc";import t from"chai";import s from"sinon";import a from"sinon-chai";import{Computer as n}from"@bitcoin-computer/lib";import r from"fs";import{createLogger as o,format as c,transports as i}from"winston";import d from"dotenv";import f from"is-primitive";import l from"is-plain-object";import b from"os";import{dirname as u}from"path";import{fileURLToPath as p}from"url";import y from"util";import h from"@bitcoin-computer/bitcore-lib-ltc";import m from"pg-promise";import g from"pg-monitor";import"exponential-backoff";const{deleteProperty:w}=Reflect;const v=f;const S=l;const T=e=>"object"==typeof e&&null!==e||"function"==typeof e;const E=e=>{if(!v(e))throw new TypeError("Object keys must be strings or symbols");if((e=>"__proto__"===e||"constructor"===e||"prototype"===e)(e))throw new Error(`Cannot set unsafe key: "${e}"`)};const $=(e,t)=>t&&"function"==typeof t.split?t.split(e):"symbol"==typeof e?[e]:Array.isArray(e)?e:((e,t,s)=>{const a=(e=>Array.isArray(e)?e.flat().map(String).join(","):e)(t?((e,t)=>{if("string"!=typeof e||!t)return e;let s=e+";";return void 0!==t.arrays&&(s+=`arrays=${t.arrays};`),void 0!==t.separator&&(s+=`separator=${t.separator};`),void 0!==t.split&&(s+=`split=${t.split};`),void 0!==t.merge&&(s+=`merge=${t.merge};`),void 0!==t.preservePaths&&(s+=`preservePaths=${t.preservePaths};`),s})(e,t):e);E(a);const n=x.cache.get(a)||s();return x.cache.set(a,n),n})(e,t,(()=>((e,t={})=>{const s=t.separator||".";const a="/"!==s&&t.preservePaths;if("string"==typeof e&&!1!==a&&/\//.test(e))return[e];const n=[];let r="";const o=e=>{let t;""!==e.trim()&&Number.isInteger(t=Number(e))?n.push(t):n.push(e)};for(let t=0;t<e.length;t++){const a=e[t];"\\"!==a?a!==s?r+=a:(o(r),r=""):r+=e[++t]}return r&&o(r),n})(e,t)));const R=(e,t,s,a)=>{if(E(t),void 0===s)w(e,t);else if(a&&a.merge){const n="function"===a.merge?a.merge:Object.assign;n&&S(e[t])&&S(s)?e[t]=n(e[t],s):e[t]=s}else e[t]=s;return e};const x=(e,t,s,a)=>{if(!t||!T(e))return e;const n=$(t,a);let r=e;for(let e=0;e<n.length;e++){const t=n[e];const o=n[e+1];if(E(t),void 0===o){R(r,t,s,a);break}"number"!=typeof o||Array.isArray(r[t])?(T(r[t])||(r[t]={}),r=r[t]):r=r[t]=[]}return e};x.split=$,x.cache=new Map,x.clear=()=>{x.cache=new Map};var O=x;var N=r;var _="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var A=function(){function e(e,t){for(var s=0;s<t.length;s++){var a=t[s];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,s,a){return s&&e(t.prototype,s),a&&e(t,a),t}}();var H=function e(t,s){var a=s.indexOf(".");if(!~a){if(null==t)return;return t[s]}var n=s.substring(0,a),r=s.substring(a+1);if(null!=t)return t=t[n],r?e(t,r):t},C=O,P=function(e,t){if("function"!=typeof t)return JSON.parse(N.readFileSync(e));N.readFile(e,"utf-8",(function(e,s){try{s=JSON.parse(s)}catch(t){e=e||t}t(e,s)}))},M=r,k=b;var F=function(){function e(t,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=s=s||{},s.stringify_width=s.stringify_width||2,s.stringify_fn=s.stringify_fn||null,s.stringify_eol=s.stringify_eol||!1,s.ignore_dots=s.ignore_dots||!1,this.path=t,this.data=this.read()}return A(e,[{key:"set",value:function(e,t,s){var a=this;return"object"===(void 0===e?"undefined":I(e))?function(e,t){var s=0,a=[];if(Array.isArray(e))for(;s<e.length&&!1!==t(e[s],s);++s);else if("object"===(void 0===e?"undefined":_(e))&&null!==e)for(a=Object.keys(e);s<a.length&&!1!==t(e[a[s]],a[s]);++s);}(e,(function(e,t){C(a.data,t,e,s)})):this.options.ignore_dots?this.data[e]=t:C(this.data,e,t,s),this.options.autosave&&this.save(),this}},{key:"get",value:function(e){return e?this.options.ignore_dots?this.data[e]:H(this.data,e):this.toObject()}},{key:"unset",value:function(e){return this.set(e,void 0)}},{key:"append",value:function(e,t){var s=this.get(e);if(s=void 0===s?[]:s,!Array.isArray(s))throw new Error("The data is not an array!");return s.push(t),this.set(e,s),this}},{key:"pop",value:function(e){var t=this.get(e);if(!Array.isArray(t))throw new Error("The data is not an array!");return t.pop(),this.set(e,t),this}},{key:"read",value:function(e){if(!e)try{return P(this.path)}catch(e){return{}}P(this.path,(function(t,s){e(null,s=t?{}:s)}))}},{key:"write",value:function(e,t){return t?M.writeFile(this.path,e,t):M.writeFileSync(this.path,e),this}},{key:"empty",value:function(e){return this.write("{}",e)}},{key:"save",value:function(e){var t=JSON.stringify(this.data,this.options.stringify_fn,this.options.stringify_width,this.options.stringify_eol);return this.write(this.options.stringify_eol?t+k.EOL:t,e),this}},{key:"toObject",value:function(){return this.data}}]),e}();d.config();const B=new F(`${u(p(import.meta.url))}/../../package.json`,{stringify_eol:!0});const{PORT:L,ZMQ_URL:D,CHAIN:W,NETWORK:j,BCN_ENV:K,BCN_URL:G,DEBUG_MODE:q,POSTGRES_USER:U,POSTGRES_PASSWORD:Y,POSTGRES_DB:z,POSTGRES_HOST:V,POSTGRES_PORT:J,RPC_PROTOCOL:X,RPC_USER:Z,RPC_PASSWORD:Q,RPC_HOST:ee,RPC_PORT:te,SERVER_VERSION:se,DEFAULT_WALLET:ae,SYNC_HEIGHT:ne,SYNC_INTERVAL_CHECK:re,POSTGRES_MAX_PARAM_NUM:oe,DB_CONNECTION_RETRY_TIME:ce,SIGNATURE_FRESHNESS_MINUTES:ie,ALLOWED_RPC_METHODS:de,NODE_MAX_PROGRESS:fe,SYNC_MAX_PROGRESS:le,MWEB_HEIGHT:be,BCDB_START_HEIGHT:ue}=process.env;const pe=W||"LTC";const ye=j||"regtest";const he=K||"dev";const me=G||"http://127.0.0.1:3000";const ge=parseInt(q,10)||1;const we=U||"bcn";const ve=Y||"bcn";const Se=z||"bcn";const Te=V||"127.0.0.1";const Ee=parseInt(J,10)||"5432";const $e=X||"http";const Re=Z||"bcn-admin";const xe=Q||"kH4nU5Okm6-uyC0_mA5ztVNacJqZbYd_KGLl6mx722A=";const Oe=ee||"node";const Ne=parseInt(te,10)||19332;const _e=se||B.get("version");const Ie=ae||"defaultwallet";const Ae=parseInt(re,10)||3e3;const He=parseInt(le,10)||.97;const Ce=parseInt(fe,10)||He;const Pe=parseInt(oe,10)||1e4;!de||de.split(",").map((e=>new RegExp(e)));const Me=parseInt(be||"",10)||432;const ke=o({level:["error","warn","info","http","verbose","debug","silly"][ge],format:c.json(),transports:[new i.Console({format:c.combine(c.colorize(),c.timestamp({format:"MM-DD-YYYY HH:mm:ss"}),c.printf((e=>`[2m${e.timestamp}[0m ${e.level} ${e.message}`)))})],exceptionHandlers:[new i.File({filename:"logs/exceptions.log"})],rejectionHandlers:[new i.File({filename:"logs/rejections.log"})]});const Fe={maxFiles:1,maxSize:1e5};ge>=0&&ke.add(new i.File({filename:"error.log",level:"error"})),ge>=1&&ke.add(new i.File({filename:"logs/warn.log",level:"warn",...Fe})),ge>=2&&ke.add(new i.File({filename:"logs/info.log",level:"info",...Fe})),ge>=3&&ke.add(new i.File({filename:"logs/http.log",level:"http",...Fe})),ge>=4&&ke.add(new i.File({filename:"logs/verbose.log",level:"verbose",...Fe})),ge>=5&&ke.add(new i.File({filename:"logs/debug.log",level:"debug",...Fe}));const Be=e=>new Promise((t=>{setTimeout(t,e)}));const Le=(e,t)=>Object.assign(new Array(t).fill(null),e);const De=new e({protocol:$e,user:Re,pass:xe,host:Oe,port:Ne});const We=y.promisify(e.prototype.createwallet.bind(De));const je=y.promisify(e.prototype.generateToAddress.bind(De));const Ke=y.promisify(e.prototype.getaddressinfo.bind(De));const Ge=y.promisify(e.prototype.getBlock.bind(De));const qe=y.promisify(e.prototype.getBlockchainInfo.bind(De));const Ue=y.promisify(e.prototype.getBlockHash.bind(De));const Ye=y.promisify(e.prototype.getRawTransaction.bind(De));const ze=y.promisify(e.prototype.getTransaction.bind(De));const Ve=y.promisify(e.prototype.getNewAddress.bind(De));const Je={createwallet:We,generateToAddress:je,getaddressinfo:Ke,getBlock:Ge,getBlockchainInfo:qe,getBlockHash:Ue,getRawTransaction:Ye,getTransaction:ze,importaddress:y.promisify(e.prototype.importaddress.bind(De)),listunspent:y.promisify(e.prototype.listunspent.bind(De)),sendRawTransaction:y.promisify(e.prototype.sendRawTransaction.bind(De)),getNewAddress:Ve,sendToAddress:y.promisify(e.prototype.sendToAddress.bind(De))};const Xe={error:(e,t)=>{if(t.cn){const{host:s,port:a,database:n,user:r,password:o}=t.cn;ke.debug(`Waiting for db to start { message:${e.message} host:${s}, port:${a}, database:${n}, user:${r}, password: ${o}`)}},noWarnings:!0};"dev"===he&&ge>0&&(g.isAttached()?g.detach():(g.attach(Xe),g.setTheme("matrix")));const Ze=m(Xe)({host:Te,port:Ee,database:Se,user:we,password:ve,allowExitOnIdle:!0,idleTimeoutMillis:100});const{PreparedStatement:Qe}=m;class et{static async select(e){const t=new Qe({name:`Input.select.${Math.random()}`,text:'SELECT "rev" FROM "Input" WHERE "rev" = $1',values:[e]});return Ze.any(t)}static async insert(e){const t=e.flatMap((e=>[e.rev]));for(;t.length;){const e=t.splice(0,Pe);const s=[];for(let t=1;t<=e.length;t+=1)s.push(`($${t})`);const a=s.join(",");const n=new Qe({name:`Input.insert.${Math.random()}`,text:`INSERT INTO "Input"("rev") VALUES ${a}  ON CONFLICT DO NOTHING`,values:e});await Ze.none(n)}}static async count(e){const t=e.map((e=>e.rev));const s=new Qe({name:`Input.belong.${Math.random()}`,text:'SELECT count(*) FROM "Input" WHERE "rev" LIKE ANY ($1)',values:[[t]]});const a=await Ze.oneOrNone(s);return parseInt(a?.count,10)||0}}const{Transaction:tt}=h;const{Input:st}=tt;class at{static getNonCoinbaseRevs=e=>e.map((e=>st.fromObject({...e,script:e._scriptBuffer}))).filter((e=>!e.isNull())).map((({prevTxId:e,outputIndex:t})=>({rev:`${e.toString("hex")}/${t}`})));static insert=async e=>class{static async select(e){return et.select(e)}static async insert(e){return et.insert(e)}}.insert(this.getNonCoinbaseRevs(e))}const{PreparedStatement:nt}=m;class rt{static async select(e){const t=new nt({name:`Output.select.${Math.random()}`,text:'SELECT "address", "satoshis", "scriptPubKey", "rev" FROM "Output" WHERE "address" = $1',values:[e]});return Ze.any(t)}static async insert(e){const t=e.flatMap((e=>[e.rev,e.address,e.satoshis,e.scriptPubKey]));for(;t.length;){const e=t.splice(0,Pe);const s=[];for(let t=1;t<=e.length;t+=4)s.push(`($${t}, $${t+1}, $${t+2}, $${t+3})`);const a=s.join(",");const n=new nt({name:`Output.insert.${Math.random()}`,text:`INSERT INTO "Output"("rev", "address", "satoshis", "scriptPubKey") VALUES ${a}  ON CONFLICT DO NOTHING`,values:e});await Ze.none(n)}}}const{Script:ot}=h;class ct{static insert=async e=>{const t=e.flatMap((e=>e.tx.outputs.map(((t,s)=>{const a=ot.fromBuffer(t._scriptBuffer);let n=a.toAddress(ye).toString("legacy");"false"===n&&(n=null);const r=a.toHex();const o=Math.round(t.satoshis);return{address:n,rev:`${e.txId}/${s}`,scriptPubKey:r,satoshis:o}}))));return class{static async select(e){return rt.select(e)}static async insert(e){return rt.insert(e)}}.insert(t)}}const{PreparedStatement:dt}=m;class ft{static async query(e){const{publicKey:t,classHash:s}=e;if(void 0===t&&void 0===s)return[];let a='SELECT "rev"\n      FROM "NonStandard"\n      WHERE true ';const n=[];t&&(n.push(t),a+=' AND $1 = ANY ("publicKeys")'),s&&(n.push(s),a+=` AND "classHash" = $${n.length}`);const r=new dt({name:`NonStandard.query.${Math.random()}`,text:a,values:n});return(await Ze.any(r)).map((e=>e.rev))}static async insert({id:e,rev:t,publicKeys:s,classHash:a}){const n=new dt({name:`NonStandard.insert.${Math.random()}`,text:'INSERT INTO "NonStandard"("id", "rev", "publicKeys", "classHash") VALUES ($1, $2, $3, $4) ON CONFLICT DO NOTHING',values:[e,t,s,a]});await Ze.none(n)}static async update({id:e,rev:t,publicKeys:s}){const a=new dt({name:`NonStandard.update.${Math.random()}`,text:'UPDATE "NonStandard" SET "rev"=$2, "publicKeys"=$3 WHERE "id" = $1',values:[e,t,s]});return Ze.none(a)}static async getRevsByIds(e){const t=new dt({name:`NonStandard.getRevsByIds.${Math.random()}`,text:'SELECT "rev" FROM "NonStandard" WHERE "id" LIKE ANY($1)',values:[[e]]});return Ze.any(t)}static async select(e){const t=new dt({name:`NonStandard.select.${Math.random()}`,text:'SELECT "id", "classHash" FROM "NonStandard" WHERE "rev" = $1',values:[e]});return Ze.oneOrNone(t)}}class lt{static async select(e){return ft.select(e)}static async query(e){return ft.query(e)}static async getRevsByIds(e){return ft.getRevsByIds(e)}static async insert(e){return ft.insert(e)}static async update(e){return ft.update(e)}}const{crypto:bt}=h;class ut{static add=async(e,t,s)=>{const a=Math.max(e.length,t.length);const n=Le(e,a);const r=Le(t,a);const o=(c=r,n.map(((e,t)=>[e,c[t]])));var c;await Promise.all(o.map((async([e,t],a)=>{const{__cls:n="",_owners:r=[]}=s[a]||{};if(null===e&&t)return/^[0-9A-Fa-f]{64}\/\d+$/.test(t),void await lt.insert({id:t,rev:t,publicKeys:r,classHash:bt.Hash.sha256(Buffer.from(n)).toString("hex")});if(t&&e){const{id:s,classHash:a}=await lt.select(e)||{};await lt.update({id:s,rev:t,publicKeys:r,classHash:a})}})))};static query=async e=>lt.query(e);static getRevsByIds=async e=>(await lt.getRevsByIds(e)).map((e=>e.rev))}const{PreparedStatement:pt}=m;class yt{static async select(){return Ze.one('SELECT "syncedHeight", "bitcoindSyncedHeight", "bitcoindSyncedProgress" FROM "SyncStatus"')}static async update({syncedHeight:e,bitcoindSyncedHeight:t,bitcoindSyncedProgress:s}){const a=new pt({name:`SyncStatus.update.${Math.random()}`,text:'UPDATE "SyncStatus" SET "syncedHeight" = $1, "bitcoindSyncedHeight" = $2, "bitcoindSyncedProgress" = $3',values:[e,t,s]});await Ze.any(a)}}class ht{static async select(){return yt.select()}static async update(e){await yt.update(e)}}class mt{static updateSync=async e=>ht.update(e);static selectSync=async()=>ht.select()}const gt=new n({chain:pe,network:ye,url:me});class wt{static syncTx=async e=>{if(await ct.insert([e]),await at.insert(e.tx.inputs),e.isBcdbTx()){const{inRevs:t=[],outRevs:s=[],outData:a=[]}=e;await ut.add(t,s,a)}};static rawTxSubscriber=async e=>{try{const t=e.toString("hex");ke.info(`ZMQ message { rawTx:${t} }`),"dev"===he&&r.appendFileSync("zmqlog.log",`${t} \r\n`);const s=await gt.db.fromTxHex(t);try{await this.syncTx(s)}catch(e){ke.error(`Error parsing transaction ${e.message} ${e.stack}`)}}catch(e){ke.error(`RawTxSubscriber failed with error '${e.message} ${e.stack}'`)}};static checkSyncEnd=async()=>{let e=-1;let t=-1;let s=0;ke.info(`Checking sync progress...syncedHeight: -1 from -1 NODE_MAX_PROGRESS ${Ce}`);do{({syncedHeight:e,bitcoindSyncedHeight:t,bitcoindSyncedProgress:s}=await mt.selectSync()),e>0?ke.info(`Sync progress ${e}/${t} blocks [${(e/t*100).toFixed(4)}% (bitcoind progress: ${(100*s).toFixed(4)}%)]`):ke.info(`Sync progress initializing... ${e}/${t} blocks `),await Be(Ae)}while(e<t||s<Ce);ke.info(`BCN reaches sync end...currentBlockHeight: ${e} from ${t} (chain progress: ${(100*s).toFixed(4)})`)};static createWallet=async()=>{try{await Je.createwallet(Ie)}catch(e){ke.debug(`Wallet creation failed with error '${e.message}'`)}};static sub=async e=>{try{await this.createWallet(),"regtest"!==ye&&await this.checkSyncEnd(),await(async()=>{if("LTC"===pe&&"regtest"===ye){ke.info(`Node is starting for chain ${pe} and network ${ye}, Starting MWEB setup.`);const{result:e}=await Je.getBlockchainInfo();const t=e.blocks;if(t<Me){const{result:e}=await Je.getNewAddress("","legacy");const s=Me-t-1;s&&await Je.generateToAddress(s,e);const{result:a}=await Je.getNewAddress("mweb","mweb");await Je.sendToAddress(a,1),await Je.generateToAddress(1,e)}ke.info("MWEB setup is complete")}})(),ke.info(`Bitcoin Computer Node is ready ${_e}`);for await(const[,t]of e)await this.rawTxSubscriber(t)}catch(e){ke.error(`ZMQ subscription failed with error '${e.message}'`)}}}t.use(a);const{expect:vt}=t;afterEach((()=>{s.restore()})),describe("zmqsub",(()=>{describe("rawTxSubscriber",(()=>{it("Should ignore a standard rawtx",(async()=>{const t="01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0704ffff001d0104ffffffff0100f2052a0100000043410496b538e853519c726a2c91e61ec11600ae1390813a627c66fb8be7947be63c52da7589379515d4e0a604f8141781e62294721166bf621e73a82cbf2342c858eeac00000000";const a="0e3e2357e806b6cdb1f70b54c3a3a17b6714ee1f0e68bebb44a74b1efd512098";const n={txid:a,hash:"906c7434c759c8baf9bea2429a849942143cbed7bae22d34086bbfbafff2c582",version:1,vin:[],vout:[{value:50,n:0,scriptPubKey:{hex:"410496b538e853519c726a2c91e61ec11600ae1390813a627c66fb8be7947be63c52da7589379515d4e0a604f8141781e62294721166bf621e73a82cbf2342c858eeac",addresses:["12c6DSiU4Rq3P4ZxziKxzrL5LmMBrzjrJX"]},txId:a}],nLockTime:0};const r={};r[t]=n;const o=s.stub(ct,"insert").resolves();const c=s.stub(ut,"add");const i=s.stub(e.prototype,"decodeRawTransaction").callsFake(((e,t)=>{t(null,{result:r[e]})}));await wt.rawTxSubscriber(t),vt(c.notCalled).to.be.true,c.restore(),i.restore(),o.restore()})),it("Should sync a coinbase testnet rawtx",(async()=>{const t="01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0b03c58c01062f503253482fffffffff0386600f27010000001976a914dde4906f870df11cf316b15adb628a3c3cc9883988ac8ab8f60200000000434104ffd03de44a6e11b9917f3a29f9443283d9871c9d743ef30d5eddcd37094b64d1b3d8090496b53256786bf5c82932ec23c3b74d9f05a6f95a8b5529352656664bac00000000000000002a6a28e73cd21eb4ac1eb1ba3767f4bf12be98935656451df3d6dee34c125662bcd599000000000000010000000000";const a=new n;const r=await a.db.fromTxHex(t);const o={};o[t]=r;const c=s.stub(ct,"insert").resolves();const i=s.stub(at,"insert").resolves();const d=s.stub(ut,"add").resolves();const f=s.stub(e.prototype,"decodeRawTransaction").callsFake(((e,t)=>{t(null,{result:o[e]})}));await wt.rawTxSubscriber(t),vt(c.args[0][0][0].tx.outputs.length).to.eq(r.tx.outputs.length),vt(i.calledWith(r.tx.inputs)).to.be.true,vt(d.notCalled).to.be.true,f.restore(),c.restore(),i.restore(),d.restore()})),it("Should sync another coinbase testnet rawtx",(async()=>{const t="01000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0b03c58c01062f503253482fffffffff0386600f27010000001976a914dde4906f870df11cf316b15adb628a3c3cc9883988ac8ab8f60200000000434104ffd03de44a6e11b9917f3a29f9443283d9871c9d743ef30d5eddcd37094b64d1b3d8090496b53256786bf5c82932ec23c3b74d9f05a6f95a8b5529352656664bac00000000000000002a6a28e73cd21eb4ac1eb1ba3767f4bf12be98935656451df3d6dee34c125662bcd599000000000000010000000000";const a=new n;const r=await a.db.fromTxHex(t);const o={};o[t]=r;const c=s.stub(ct,"insert").resolves();const i=s.stub(at,"insert").resolves();const d=s.stub(ut,"add").resolves();const f=s.stub(e.prototype,"decodeRawTransaction").callsFake(((e,t)=>{t(null,{result:o[e]})}));await wt.rawTxSubscriber(t),vt(c.args[0][0][0].tx.outputs.length).to.eq(r.tx.outputs.length),vt(i.calledWith(r.tx.inputs)).to.be.true,vt(d.notCalled).to.be.true,f.restore(),c.restore(),i.restore(),d.restore()})),it("Should sync bcdb testnet rawtx",(async()=>{const t="0200000002ed71bf8538dce5cde4fa704091349280c9b8ed734abba0e5ea577293e2affadc020000006b483045022100d6f97b6c4404b12d59c9b98ce44669f99dca440904432573bf7e7bde5b465ce5022040e5c3c27c924e27e213ae09130d2d81fc33b33b6ee5aade076abd3caaacdb980121028440227b67c9c930faaac1f23d78967ac3cf129d734c76bdbd25027cdf4042d0ffffffff869d3597c68a643d804e34a245478f959aeb19b4e82fd516e93d990ca3d8000b000000006b483045022100f07f8a54586b66ddcde86f544538dd64997e011885216880c20808e38a15cbb502202a663b78a1a0f696ec9386824c64d777d0d90e306cfd3922bc921c6bf0b04b600121028440227b67c9c930faaac1f23d78967ac3cf129d734c76bdbd25027cdf4042d0ffffffff0a643c000000000000255121028440227b67c9c930faaac1f23d78967ac3cf129d734c76bdbd25027cdf4042d051ae643c0000000000006951210201e8d2e6e85840eae4d85240f6b8dc40404040e8d0d2e65ce8d2e8d8ca407a40210202d1a5d1b194ed71b880808081d1a1a5ccb985c9d1a5cdd080f48185c9d1a5cd2103d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d02953ae643c0000000000006951210203a1dae37101010103a3434b9973ab936101e903ab9361dae3710103eae372e32102006e20207365744f776e6572286f776e657229207b5c6e20202020746869732e2103d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d02953ae643c00000000000069512102027dbdddb995c9cc80f4816dbdddb995c974ed71b88081f571b971b9f488b089210201bebec2e4cee64474b64482d8d84458449ad2d8de445844d0e8e8e0e6745e5e2103d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d02953ae643c0000000000006951210202dddddcb985c9d194b5bdb9b1a5b994b9b995d0bdd985c8bd85c9d1957dbdb92102006c696e655f6e65742f73746f726167652f696d616765732f617274652d6f6e2103d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d02953ae643c00000000000069512102006c696e652f6e6f7461732f6c6c6567615f626164615f323031372f6d696c6f2102005f6c6f636b6574742f3732343037332d312d65736c2d41522f4d696c6f5f4c2103d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d02953ae643c0000000000004751210201000000000000000000000000dec6d6cae8e8bedec4e4c25cd4e0ce44bafaba2103d92bbbd61e057a68d266ba234842393c03455e8eda5df591ab1d344b1d30d02952ae0000000000000000536a4c503030303030313030375b7b225f5f696e646578223a7b226f626a223a307d2c225f5f636c73223a22636c61737320417274776f726b207b5c6e2020636f6e7374727563746f72287469746c652c206172d08e0000000000001976a91477fd2a76764dfdc6ef085bdc307cdc3ffe17a83388acfc630400000000001976a914a1a4ae9783d4ee736df6b62f6a9cc0ed06e1f12f88ac00000000";const a=new n({chain:"LTC",network:"testnet"});const r=await a.db.fromTxHex(t);const o={};o[t]=r;const c=s.stub(ct,"insert").resolves();const i=s.stub(at,"insert").resolves();const d=s.stub(ut,"add").resolves();const f=s.stub(e.prototype,"decodeRawTransaction").callsFake(((e,t)=>{t(null,{result:o[e]})}));await wt.rawTxSubscriber(t),vt(c.args[0][0][0].tx.outputs.length).to.eq(r.tx.outputs.length),vt(i.calledWith(r.tx.inputs)).to.be.true,vt(d.getCall(0).args[0].length).to.eq(0),vt(d.getCall(0).args[1].length).to.eq(1),vt(d.getCall(0).args[2].length).to.eq(1),f.restore(),c.restore(),i.restore(),d.restore()}))}))}));
